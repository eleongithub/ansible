---
# This playbook deploys the whole application.  

# 1 - Apply common & firewall roles to all nodes
#- hosts: dbserver:tomcat:apache
- hosts: tomcat:apache
  become: yes
  roles:
    - common
    - firewall
    
# 2  - Install java/jdk 
- hosts: tomcat
  become: yes
  pre_tasks:
   - name: Get java version installed on the nodes
     shell: java -version 2>&1 | head -n 1 | cut -d'"' -f2
     register: java_installed_version
  roles:
    - { role: jdk, when: " '{{ java_installed_version.stdout }}' != '{{ java_version }}'" }
    
# Install data base
- hosts: dbserver
  become: yes
  roles:
    - postgres 
    
# Install data base
- hosts: dbserver
  become: yes
  roles:
    - postgres_instance

# Install Tomcat
- hosts: tomcat
  become: yes
  roles:
    - tomcat
    
## Install Apache2
#- hosts: apache
  #become: yes
  #roles:
    #- apache   
    
## Install Apache Virtual hosts
#- hosts: apache-front
  #become: yes
  #roles:
    #- apache_vhosts