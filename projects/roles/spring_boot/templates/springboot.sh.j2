#!/bin/bash
### BEGIN INIT INFO
# Provides:          springboot
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start springboot at boot time
# Description:       Enable service provided by springboot
### END INIT INFO

# User
SPRING_BOOT_USER={{ spgboot_user }}

# Start command
START_COMMAND="java -Dconf.file={{ spring_boot_conf_directory }} -Xbootclasspath/p:{{ spring_boot_conf_directory }} -Xmx512m -Xms256m -jar {{ spring_boot_main_directory }}/{{ spring_boot_apps_jar_name }}"

# Log file for start/stop
SPRING_BOOT_LOG_START_STOP="{{ spring_boot_logs_directory }}/startSpringBoot.log"

# TOMCAT_USAGE is the message if this script is called without any options
SPRING_BOOT_USAGE="Usage: $0 {\e[00;32mstart\e[00m|\e[00;31mstop\e[00m|\e[00;32mstatus\e[00m|\e[00;31mrestart\e[00m}"

# SHUTDOWN_WAIT is wait time in seconds for java proccess to stop
SHUTDOWN_WAIT=20

springboot_pid() {
    echo `ps faxww | grep -v awk | grep -v grep | awk '/{{ spring_boot_apps_artifactid }}/{print $1}'`
}

start() {
  pid=$(springboot_pid)
  if [ -n "$pid" ]
  then
    echo -e "\e[00;31mSpring Boot is already running (pid: $pid)\e[00m"
  else
    # Start tomcat
    echo -e "\e[00;32mStarting Spring Boot\e[00m"
    /bin/su $SPRING_BOOT_USER $START_COMMAND > $SPRING_BOOT_LOG_START_STOP 2>&1 &
  fi
  return 0
}


stop() {
  pid=$(springboot_pid)
  if [ -n "$pid" ]
  then
    echo -e "\e[00;31mStoping Spring Boot\e[00m"
    # Kill Spring Boot process
    kill -SIGTERM $pid >> $SPRING_BOOT_LOG_START_STOP 2>&1
    let kwait=$SHUTDOWN_WAIT
    count=0;
    until [ `ps -p $pid | grep -c $pid` = '0' ] || [ $count -gt $kwait ]
    do
      echo -n -e "\n\e[00;31mwaiting for processes to exit\e[00m";
      sleep 1
      let count=$count+1;
    done
 
    if [ $count -gt $kwait ]; then
      echo -n -e "\n\e[00;31mkilling processes which didn't stop after $SHUTDOWN_WAIT seconds\e[00m"
      kill -9 $pid
    fi
  else
    echo -e "\e[00;31mSpring Boot is not running\e[00m"
  fi
 
  return 0
}

status(){
  pid=$(springboot_pid)
  if [ -n "$pid" ]; then echo -e "\e[00;32mSpring Boot is running with pid: $pid\e[00m"
  else echo -e "\e[00;31mSpring Boot is not running\e[00m"
  fi
}

case $1 in
 
        start)
          start
        ;;
       
        stop)  
          stop
        ;;
       
        restart)
          stop
          start
        ;;
       
        status)
          status  
        ;;
       
        *)
          echo -e $SPRING_BOOT_USAGE
        ;;
esac    
exit 0